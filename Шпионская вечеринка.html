<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–ø–∏–æ–Ω—Å–∫–∞—è –≤–µ—á–µ—Ä–∏–Ω–∫–∞</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --bg-color: #1a1a2e; --primary-color: #16213e; --secondary-color: #0f3460; --accent-color: #e94560; --text-color: #dcdcdc; --font-spy: 'Courier New', monospace;}
        body, html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 1rem; }
        .container { width: 100%; max-width: 500px; background-color: var(--primary-color); border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.4); margin: 2rem auto; }
        .screen { display: none; padding: 1.5rem; flex-direction: column; gap: 1rem; }
        .screen.active { display: flex; }
        h1, h2, h3, h4 { text-align: center; color: var(--accent-color); margin: 0; }
        h2, h3, h4 { color: var(--text-color); }
        h4 { margin-top: 1rem; }
        p { text-align: center; font-size: 0.9rem; opacity: 0.8; line-height: 1.4; }
        input[type="text"] { width: 100%; padding: 0.8rem; background-color: var(--secondary-color); border: 2px solid transparent; border-radius: 8px; color: var(--text-color); font-size: 1rem; box-sizing: border-box; text-align: center; }
        button { padding: 1rem; border: none; border-radius: 8px; background-color: var(--accent-color); color: white; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; width: 100%; }
        button:hover:not(:disabled) { background-color: #ff5777; transform: translateY(-2px); }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .button-group { display: flex; flex-direction: column; gap: 1rem; }
        .button-group small { font-size: 0.8rem; opacity: 0.7; }
        .back-btn { background: none; border: 1px solid var(--secondary-color); font-size: 0.9rem; padding: 0.5rem 1rem; width: auto; align-self: flex-start; margin-bottom: 0.5rem; }
        .qr-container { display: flex; justify-content: center; align-items: center; background: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; align-self: center; }
        #qr-scanner-container, #qr-scanner-container-client { width: 100%; max-width: 300px; border: 2px solid var(--secondary-color); border-radius: 8px; overflow: hidden; align-self: center; }
        .room-code-display { font-size: 2.5rem; font-weight: bold; text-align: center; letter-spacing: 0.5rem; padding: 1.5rem; background: var(--secondary-color); border-radius: 8px; }
        #lobby-players-list, #results-list { list-style: none; padding: 0; margin: 0; text-align: center; }
        #lobby-players-list li, #results-list li { padding: 0.5rem; background: var(--secondary-color); border-radius: 5px; margin-bottom: 0.5rem; }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ */
        .instructions-container { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem; }
        .accordion { background-color: var(--secondary-color); color: var(--text-color); cursor: pointer; padding: 1rem; width: 100%; border: none; text-align: left; outline: none; font-size: 1rem; font-weight: bold; transition: background-color 0.4s; border-radius: 8px; }
        .accordion:hover, .accordion.active { background-color: #0d2c54; }
        .accordion::after { content: '\002B'; color: var(--accent-color); font-weight: bold; float: right; margin-left: 5px; }
        .accordion.active::after { content: '\2212'; }
        .panel { padding: 0 1.5rem; background-color: var(--primary-color); max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .panel p, .panel ul { font-size: 0.9rem; line-height: 1.5; text-align: left; margin-top: 1rem; }
        .panel p:last-child, .panel ul:last-child { margin-bottom: 1rem; }
        .panel ul { padding-left: 1.2rem; }
        .panel b { color: var(--accent-color); }
        .panel hr { border-color: var(--secondary-color); opacity: 0.5; margin: 1.5rem 0; }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–≥—Ä—ã */
        #game-info { display: flex; justify-content: space-between; align-items: center; background: var(--secondary-color); padding: 0.5rem 1rem; border-radius: 8px; }
        #my-role { font-weight: bold; } .role-spy { color: var(--accent-color); font-family: var(--font-spy); } .role-detective { color: #45e9a0; } .role-civilian { color: #45a0e9; }
        #player-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .player-card { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: var(--secondary-color); border-radius: 8px; border-left: 5px solid transparent; }
        .player-card.is-spy { border-left-color: var(--accent-color); } .player-card.is-you { background: #2a3a5e; } .player-card.is-dead { opacity: 0.5; text-decoration: line-through; }
        .player-actions button { padding: 0.4rem 0.8rem; font-size: 0.8rem; width: auto; margin-left: 0.5rem; }
    </style>
</head>
<body>

<div class="container">
    <!-- 1. –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="main-menu" class="screen active">
        <h1>–®–ø–∏–æ–Ω—Å–∫–∞—è –≤–µ—á–µ—Ä–∏–Ω–∫–∞</h1>
        
        <div class="instructions-container">
            <button class="accordion">–¶–µ–ª—å –∏ –ü—Ä–∞–≤–∏–ª–∞</button>
            <div class="panel">
                <p><b>–ñ–∏—Ç–µ–ª–∏</b> –¥–æ–ª–∂–Ω—ã –≤—ã—á–∏—Å–ª–∏—Ç—å –∏ –∏–∑–≥–Ω–∞—Ç—å –≤—Å–µ—Ö —à–ø–∏–æ–Ω–æ–≤ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏.</p>
                <p><b>–®–ø–∏–æ–Ω—ã</b> –¥–æ–ª–∂–Ω—ã –≤—ã–∂–∏—Ç—å –¥–æ –∫–æ–Ω—Ü–∞ –∏–ª–∏ –¥–æ–±–∏—Ç—å—Å—è —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ –ø–æ —á–∏—Å–ª—É —Å –∂–∏—Ç–µ–ª—è–º–∏.</p>
                <p><b>–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏</b> –∏–º–µ—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –ø–æ–±–µ–¥—ã.</p>
                <hr>
                <h4>–§–∞–∑—ã –∏–≥—Ä—ã:</h4>
                <ul>
                    <li><b>–û–±—Å—É–∂–¥–µ–Ω–∏–µ:</b> –ò–≥—Ä–æ–∫–∏ –≤—ã—Å–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ–¥–æ–∑—Ä–µ–Ω–∏—è.</li>
                    <li><b>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ:</b> –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞.</li>
                    <li><b>–ù–æ—á–Ω–∞—è —Ñ–∞–∑–∞:</b> –®–ø–∏–æ–Ω—ã –∏ –æ—Å–æ–±—ã–µ —Ä–æ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ä–µ–∂–∏–º–∞—Ö).</li>
                </ul>
            </div>
            <button class="accordion">–û–ø–∏—Å–∞–Ω–∏–µ –†–æ–ª–µ–π</button>
            <div class="panel">
                <h4>–ö–æ–º–∞–Ω–¥–∞ –ñ–∏—Ç–µ–ª–µ–π</h4>
                <p><b>–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å:</b> –ì–æ–ª–æ—Å—É–µ—Ç, –∏—â–µ—Ç —à–ø–∏–æ–Ω–æ–≤.</p>
                <p><b>–î–µ—Ç–µ–∫—Ç–∏–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</b> –ú–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–æ–ª–∏ –∏–≥—Ä–æ–∫–æ–≤, –Ω–æ –Ω–µ –≥–æ–ª–æ—Å—É–µ—Ç.</p>
                <p><b>–¢–µ–ª–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å:</b> 1 —Ä–∞–∑ –∑–∞ –∏–≥—Ä—É –æ—Ç–º–µ–Ω—è–µ—Ç –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞.</p>
                <hr>
                <h4>–ö–æ–º–∞–Ω–¥–∞ –®–ø–∏–æ–Ω–æ–≤</h4>
                <p><b>–®–ø–∏–æ–Ω:</b> –ó–Ω–∞–µ—Ç –¥—Ä—É–≥–∏—Ö —à–ø–∏–æ–Ω–æ–≤, –º–æ–∂–µ—Ç —Å–∞–±–æ—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.</p>
                <p><b>–î–≤–æ–π–Ω–æ–π –∞–≥–µ–Ω—Ç:</b> –®–ø–∏–æ–Ω, –Ω–æ –Ω–µ –∑–Ω–∞–µ—Ç –¥—Ä—É–≥–∏—Ö —à–ø–∏–æ–Ω–æ–≤. –ú–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ —à–ø–∏–æ–Ω–∞–º.</p>
                <hr>
                <h4>–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ / –•–∞–æ—Ç–∏—á–Ω—ã–µ –†–æ–ª–∏</h4>
                <p><b>–õ–∂–µ—Ü:</b> –î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –Ω–µ–∑–∞–º–µ—á–µ–Ω–Ω—ã–º. –ú–æ–∂–µ—Ç –ø–æ–¥–¥–µ–ª—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.</p>
                <p><b>–°–∞–º–æ–∑–≤–∞–Ω–µ—Ü:</b> –í—ã–¥–∞—ë—Ç —Å–µ–±—è –∑–∞ –¥–µ—Ç–µ–∫—Ç–∏–≤–∞. –ü–æ–±–µ–∂–¥–∞–µ—Ç, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ —Ä–∞–∑–æ–±–ª–∞—á–∞—Ç.</p>
            </div>
            <button class="accordion">–°—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –ü—Ä–µ–¥–º–µ—Ç—ã (–¥–ª—è –≤–µ–¥—É—â–µ–≥–æ)</button>
            <div class="panel">
                <p>–≠—Ç–∏ —Å–µ—Ç—Ç–∏–Ω–≥–∏ –∏ –ø—Ä–µ–¥–º–µ—Ç—ã ‚Äî –∏–¥–µ–∏ –¥–ª—è –∏–≥—Ä —Å –≤–µ–¥—É—â–∏–º. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏—Ö –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã!</p>
                <h4>1. –î–µ—Ç–µ–∫—Ç–∏–≤ –≤ –∑–∞–ø–µ—Ä—Ç–æ–º –æ—Å–æ–±–Ω—è–∫–µ</h4>
                <p><i>–ü—Ä–µ–¥–º–µ—Ç—ã:</i> –ö–ª—é—á –æ—Ç –∫–∞–±–∏–Ω–µ—Ç–∞, —è–¥ –≤ –±–æ–∫–∞–ª–µ, —Ñ–∞–ª—å—à–∏–≤—ã–π –¥–Ω–µ–≤–Ω–∏–∫.<br><i>–ü–æ–≤–æ—Ä–æ—Ç:</i> ¬´–í –∫–∞—Ä–º–∞–Ω–µ –≤—ã–≥–Ω–∞–Ω–Ω–æ–≥–æ –Ω–∞—Ö–æ–¥—è—Ç –∫–ª—é—á‚Ä¶ –Ω–æ –¥–≤–µ—Ä—å, –∫–æ—Ç–æ—Ä—É—é –æ–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç, —É–∂–µ –≤–∑–ª–æ–º–∞–Ω–∞¬ª.</p>
                <h4>2. –ú—è—Ç–µ–∂ –Ω–∞ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–º –∫–æ—Ä–∞–±–ª–µ</h4>
                <p><i>–ü—Ä–µ–¥–º–µ—Ç—ã:</i> –ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª—É, –æ–±—Ä–∞–∑–µ—Ü –≤–∏—Ä—É—Å–∞, —Å–ª–æ–º–∞–Ω–Ω—ã–π –º–∞—è–∫.<br><i>–ü–æ–≤–æ—Ä–æ—Ç:</i> ¬´–î–∞–≤–ª–µ–Ω–∏–µ –ø–∞–¥–∞–µ—Ç‚Ä¶ –∫—Ç–æ-—Ç–æ –æ—Ç–∫—Ä—ã–ª —à–ª—é–∑¬ª.</p>
                <h4>3. –ü—Ä–æ–∫–ª—è—Ç–∞—è –¥–µ—Ä–µ–≤–Ω—è (–æ–±–æ—Ä–æ—Ç–µ–Ω—å)</h4>
                <p><i>–ü—Ä–µ–¥–º–µ—Ç—ã:</i> –°–µ—Ä–µ–±—Ä—è–Ω—ã–π –∫–∏–Ω–∂–∞–ª, —Å–≤—è—Ç–∞—è –≤–æ–¥–∞, –∑–∞–ø–∏—Å–∏ —à–∞–º–∞–Ω–∞.<br><i>–ü–æ–≤–æ—Ä–æ—Ç:</i> ¬´–ù–∞ –ª—É–Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫—Ä–æ–≤–∞–≤–æ–µ –ø—è—Ç–Ω–æ‚Ä¶ –∫–∞–∫ –≤—á–µ—Ä–∞¬ª.</p>
                <h4>4. –ü–∏—Ä–∞—Ç—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å</h4>
                <p><i>–ü—Ä–µ–¥–º–µ—Ç—ã:</i> –ö–∞—Ä—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â, –±—É—Ç—ã–ª–∫–∞ —Ä–æ–º–∞, —Ñ–∞–ª—å—à–∏–≤—ã–π –∫–æ–º–ø–∞—Å.<br><i>–ü–æ–≤–æ—Ä–æ—Ç:</i> ¬´–ó–∞ –±–æ—Ä—Ç–æ–º –≤–∏–¥—è—Ç –∞–∫—É–ª‚Ä¶ –Ω–æ —ç—Ç–æ –∫—Ä–æ–≤—å¬ª.</p>
            </div>
        </div>
        
        <input type="text" id="player-name" placeholder="–í–∞—à–µ –∏–º—è">
        <div class="button-group">
            <button id="show-create-options-btn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
            <button id="show-join-options-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ</button>
        </div>
    </div>
    
    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <div id="create-options-screen" class="screen">
        <button class="back-btn" data-target="main-menu">‚Üê –ù–∞–∑–∞–¥</button>
        <h2>–ö–∞–∫ –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤?</h2>
        <div class="button-group">
            <button id="create-via-room-code-btn">–ü–æ –∫–æ–¥—É –∫–æ–º–Ω–∞—Ç—ã <small>(–ø—Ä–æ—â–µ, –Ω—É–∂–µ–Ω –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)</small></button>
            <button id="create-via-qr-btn">–ü–æ QR-–∫–æ–¥—É <small>(–±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)</small></button>
        </div>
    </div>

    <div id="join-options-screen" class="screen">
        <button class="back-btn" data-target="main-menu">‚Üê –ù–∞–∑–∞–¥</button>
        <h2>–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è?</h2>
        <div class="button-group">
            <button id="join-via-room-code-btn">–í–≤–µ—Å—Ç–∏ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</button>
            <button id="join-via-qr-btn">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</button>
        </div>
    </div>
    
    <div id="host-lobby-screen" class="screen">
        <button class="back-btn" data-target="create-options-screen">‚Üê –ù–∞–∑–∞–¥</button>
        <div id="host-room-code-section" style="display:none;">
            <h3>–í–∞—à –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</h3>
            <div id="room-code-display" class="room-code-display">....</div>
            <p>–°–æ–æ–±—â–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º.</p>
        </div>
        <div id="host-qr-section" style="display:none;">
            <p><strong>–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong> –ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç QR-–∫–æ–¥ –∏–≥—Ä–æ–∫—É, –∞ –∑–∞—Ç–µ–º –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –µ–≥–æ –æ—Ç–≤–µ—Ç.</p>
            <div class="qr-container"><canvas id="qr-offer-canvas"></canvas></div>
            <div id="qr-scanner-container"></div>
            <button id="generate-new-qr-btn">–ù–æ–≤—ã–π QR –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞</button>
        </div>
        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã -->
        <div id="game-settings" style="display: none; flex-direction: column; gap: 0.5rem; margin-top: 1rem; background: var(--secondary-color); padding: 1rem; border-radius: 8px;">
            <h4>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏:</h4>
            <label><input type="checkbox" id="enable-double-agent"> –î–≤–æ–π–Ω–æ–π –∞–≥–µ–Ω—Ç (–¥–ª—è 7+ –∏–≥—Ä–æ–∫–æ–≤)</label>
            <label><input type="checkbox" id="enable-impostor"> –°–∞–º–æ–∑–≤–∞–Ω–µ—Ü (–¥–ª—è 8+ –∏–≥—Ä–æ–∫–æ–≤)</label>
        </div>
        <hr>
        <h3>–ò–≥—Ä–æ–∫–∏ –≤ –ª–æ–±–±–∏:</h3>
        <ul id="lobby-players-list"></ul>
        <button id="start-game-btn" disabled>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É (–Ω—É–∂–Ω–æ –º–∏–Ω. 3)</button>
    </div>

    <div id="client-room-screen" class="screen">
        <button class="back-btn" data-target="join-options-screen">‚Üê –ù–∞–∑–∞–¥</button>
        <h2>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</h2>
        <input type="text" id="room-code-input" maxlength="4" style="text-transform: uppercase;">
        <button id="join-room-submit-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        <p id="client-status"></p>
    </div>

    <div id="client-qr-screen" class="screen">
        <button class="back-btn" data-target="join-options-screen">‚Üê –ù–∞–∑–∞–¥</button>
        <div id="client-qr-scan-section">
            <h3>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –•–æ—Å—Ç–∞</h3>
            <div id="qr-scanner-container-client"></div>
        </div>
        <div id="client-qr-show-section" style="display:none;">
            <h3>–ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç QR-–∫–æ–¥ –•–æ—Å—Ç—É</h3>
            <div class="qr-container"><canvas id="qr-offer-canvas" width="250" height="250"></canvas></div>
            <p>–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</p>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="game-info">
            <div id="my-role">–†–æ–ª—å: ...</div>
            <div id="timer">05:00</div>
        </div>
        <h2>–ò–≥—Ä–æ–∫–∏</h2>
        <div id="player-list"></div>
        <button id="sabotage-btn" style="display: none;" onclick="sendAction({type:'sabotage'})">üö® –£—Å—Ç—Ä–æ–∏—Ç—å —Å–∞–±–æ—Ç–∞–∂</button>
    </div>
    <div id="results-screen" class="screen">
        <h1 id="winner-display">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</h1>
        <h2>–†–∞—Å–∫—Ä—ã—Ç—ã–µ —Ä–æ–ª–∏:</h2>
        <ul id="results-list"></ul>
        <button id="play-again-btn">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
    </div>
</div>

<script>
// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyBQedtOSEprnuaMeztxCXcHsetZ4qfGwww",
  authDomain: "game-spy-party-app.firebaseapp.com",
  databaseURL: "https://game-spy-party-app-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "game-spy-party-app",
  storageBucket: "game-spy-party-app.appspot.com",
  messagingSenderId: "393837585563",
  appId: "1:393837585563:web:a08382749da7e4550dd23e"
};

// --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
let myName = '', myId = '', isHost = false, db, roomCode, hostId;
let peers = {};
let qrScanner, timerInterval;
let gameState = { players: [] };

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ---
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
} catch (e) {
    console.warn("Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –†–µ–∂–∏–º '–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã' –æ—Ç–∫–ª—é—á–µ–Ω.");
    document.getElementById('create-via-room-code-btn').disabled = true;
    document.getElementById('join-via-room-code-btn').disabled = true;
}

// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è ---
const allScreens = document.querySelectorAll('.screen');
function showScreen(screenId) {
    allScreens.forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
    if (qrScanner && typeof qrScanner.clear === 'function') {
        try { qrScanner.clear(); } catch(e) {}
    }
}
function validateAndProceed(callback) {
    myName = document.getElementById('player-name').value.trim();
    if (!myName) { alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!'); return; }
    myId = `player_${Date.now()}`;
    callback();
}
function resetStateAndGoBack(targetScreen) {
    Object.values(peers).forEach(p => p.destroy());
    peers = {};
    if (db && roomCode) {
        db.ref('rooms/' + roomCode).off();
        if (isHost) db.ref('rooms/' + roomCode).remove();
    }
    isHost = false; roomCode = undefined; hostId = undefined;
    gameState = { players: [] };
    showScreen(targetScreen);
}
document.getElementById('show-create-options-btn').addEventListener('click', () => validateAndProceed(() => { isHost = true; showScreen('create-options-screen'); }));
document.getElementById('show-join-options-btn').addEventListener('click', () => validateAndProceed(() => { isHost = false; showScreen('join-options-screen'); }));
document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', () => resetStateAndGoBack(btn.dataset.target)));
document.getElementById('play-again-btn').addEventListener('click', () => location.reload());

// --- –¢—Ä–∏–≥–≥–µ—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ---
document.getElementById('create-via-room-code-btn').addEventListener('click', startHostViaRoomCode);
document.getElementById('join-via-room-code-btn').addEventListener('click', () => showScreen('client-room-screen'));
document.getElementById('join-room-submit-btn').addEventListener('click', joinClientViaRoomCode);
document.getElementById('create-via-qr-btn').addEventListener('click', startHostViaQr);
document.getElementById('join-via-qr-btn').addEventListener('click', joinClientViaQr);

// --- –õ–æ–≥–∏–∫–∞ –•–æ—Å—Ç–∞ ---
function startHost(isRoomCode) {
    gameState = { players: [{ id: myId, name: myName }], gameStarted: false, gameOver: false };
    updateLobbyUI();
    showScreen('host-lobby-screen');
    document.getElementById('host-room-code-section').style.display = isRoomCode ? 'block' : 'none';
    document.getElementById('host-qr-section').style.display = isRoomCode ? 'none' : 'block';
}
function startHostViaRoomCode() {
    startHost(true);
    roomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
    const roomRef = db.ref('rooms/' + roomCode);
    roomRef.onDisconnect().remove();
    roomRef.set({ hostId: myId, createdAt: firebase.database.ServerValue.TIMESTAMP });
    document.getElementById('room-code-display').textContent = roomCode;
    db.ref(`rooms/${roomCode}/signals/${myId}`).on('child_added', (snapshot) => {
        const signalData = snapshot.val();
        if (!peers[signalData.senderId]) { createPeer(signalData.senderId, false); }
        peers[signalData.senderId].signal(signalData.signal);
        snapshot.ref.remove();
    });
}
function startHostViaQr() {
    startHost(false);
    generateNewQrOffer();
    qrScanner = new Html5Qrcode("qr-scanner-container");
    qrScanner.start({ facingMode: "environment" }, { fps: 10 }, (decodedText) => {
        try {
            const data = JSON.parse(decodedText);
            if (data.type === 'answer' && peers[data.peerId]) {
                peers[data.peerId].signal(data.signal);
                qrScanner.stop().catch(console.error);
                document.getElementById('qr-scanner-container').style.display = 'none';
            }
        } catch(e) {}
    }, () => {}).catch(err => alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É"));
}
document.getElementById('generate-new-qr-btn').addEventListener('click', generateNewQrOffer);
function generateNewQrOffer() {
    document.getElementById('qr-scanner-container').style.display = 'block';
    if(qrScanner && qrScanner.getState() === 'SCANNING') qrScanner.stop();
    const peerId = `qr_peer_${Date.now()}`;
    const peer = createPeer(peerId, true);
    peer.on('signal', (data) => {
        if (data.type === 'offer') {
            new QRious({ 
                element: document.getElementById('qr-offer-canvas'), 
                value: JSON.stringify({ peerId: peerId, signal: data }), 
                size: 250 // <-- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨
            });
        }
    });
}
document.getElementById('start-game-btn').addEventListener('click', () => {
    showScreen('game-screen');
    gameState.gameStarted = true; assignRoles(); resetPlayerStats();
    timerInterval = setInterval(gameTick, 1000);
    broadcastGameState();
});

// --- –õ–æ–≥–∏–∫–∞ –ö–ª–∏–µ–Ω—Ç–∞ ---
function joinClientViaRoomCode() {
    roomCode = document.getElementById('room-code-input').value.toUpperCase();
    if (roomCode.length !== 4) return;
    document.getElementById('client-status').textContent = '–ò—â–µ–º –∫–æ–º–Ω–∞—Ç—É...';
    db.ref('rooms/' + roomCode).once('value', (snapshot) => {
        if (snapshot.exists()) {
            document.getElementById('client-status').textContent = '–ö–æ–º–Ω–∞—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞! –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...';
            hostId = snapshot.val().hostId;
            createPeer(hostId, true);
            db.ref(`rooms/${roomCode}/signals/${myId}`).on('child_added', (signalSnap) => {
                if (peers[hostId]) peers[hostId].signal(signalSnap.val().signal);
                signalSnap.ref.remove();
            });
        } else document.getElementById('client-status').textContent = '–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!';
    });
}
function joinClientViaQr() {
    showScreen('client-qr-screen');
    const clientScanner = new Html5Qrcode("qr-scanner-container-client");
    const successCallback = (decodedText) => {
        clientScanner.stop().catch(console.error);
        const data = JSON.parse(decodedText);
        hostId = data.peerId;
        const peer = createPeer(hostId, false);
        peer.on('signal', (answerData) => {
             new QRious({ element: document.getElementById('qr-answer-canvas'), value: JSON.stringify({ type: 'answer', peerId: myId, signal: answerData }), size: 200 });
        });
        peer.signal(data.signal);
        document.getElementById('client-qr-scan-section').style.display = 'none';
        document.getElementById('client-qr-show-section').style.display = 'block';
    };
    clientScanner.start({ facingMode: "environment" }, { fps: 10 }, successCallback, () => {})
        .catch(err => alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –¥–∞–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ."));
}

// --- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è P2P –ª–æ–≥–∏–∫–∞ ---
function createPeer(peerId, isInitiator) {
    const peer = new SimplePeer({ initiator: isInitiator, trickle: false });
    peers[peerId] = peer;
    peer.on('error', err => { console.error('P2P Error to', peerId, err); delete peers[peerId]; if (isHost) updateLobbyUI(); });
    peer.on('signal', data => {
        if (roomCode) {
            const targetId = isHost ? peerId : hostId;
            db.ref(`rooms/${roomCode}/signals/${targetId}`).push({ senderId: myId, signal: data });
        }
    });
    peer.on('connect', () => {
        console.log('CONNECTED to', peerId);
        if (isHost) peer.send(JSON.stringify({ type: 'welcome', players: gameState.players }));
        else peer.send(JSON.stringify({ type: 'my_name_is', name: myName, id: myId }));
    });
    peer.on('data', data => handlePeerData(data, peerId));
    peer.on('close', () => {
        if (isHost) { gameState.players = gameState.players.filter(p => p.id !== peerId); broadcastLobbyUpdate(); }
        else { alert('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–æ–º –ø–æ—Ç–µ—Ä—è–Ω–æ.'); location.reload(); }
        delete peers[peerId];
    });
    return peer;
}

// --- –û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ –∏ –ª–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ---
function handlePeerData(data, peerId) {
    const msg = JSON.parse(data);
    if (isHost) {
        if (msg.type === 'my_name_is' && !gameState.players.find(p => p.id === msg.id)) {
            gameState.players.push({ id: msg.id, name: msg.name });
            broadcastLobbyUpdate();
        }
        if (msg.type === 'player_action') handlePlayerAction(msg.payload, peerId);
    } else {
        if (msg.type === 'welcome' || msg.type === 'lobby_update') {
            gameState.players = msg.players;
            showScreen('host-lobby-screen');
            document.getElementById('host-room-code-section').style.display = 'none';
            document.getElementById('host-qr-section').style.display = 'none';
            document.getElementById('start-game-btn').textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã...";
            document.getElementById('start-game-btn').disabled = true;
            updateLobbyUI();
        }
        if (msg.type === 'game_state_update') { gameState = msg.gameState; showScreen('game-screen'); updateGameUI(); }
        if (msg.type === 'game_over') showResults(msg.results);
    }
}
function broadcastToPeers(message) { Object.values(peers).forEach(p => { if (p.connected) p.send(JSON.stringify(message)); }); }
function broadcastLobbyUpdate() { updateLobbyUI(); broadcastToPeers({ type: 'lobby_update', players: gameState.players }); }
function broadcastGameState() { updateGameUI(); broadcastToPeers({ type: 'game_state_update', gameState: gameState }); }
function updateLobbyUI() {
    const list = document.getElementById('lobby-players-list');
    list.innerHTML = '';
    gameState.players.forEach(p => { list.innerHTML += `<li>${p.name} ${p.id === myId ? '(–í—ã)' : ''}</li>`; });
    if (isHost) {
        const startBtn = document.getElementById('start-game-btn');
        const settingsDiv = document.getElementById('game-settings');
        const doubleAgentCheckbox = document.getElementById('enable-double-agent');
        const impostorCheckbox = document.getElementById('enable-impostor');
        
        const playerCount = gameState.players.length;
        startBtn.disabled = playerCount < 3;
        startBtn.textContent = startBtn.disabled ? `–ù—É–∂–Ω–æ –º–∏–Ω. 3 –∏–≥—Ä–æ–∫–∞ (${playerCount}/3)` : '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!';
        
        settingsDiv.style.display = playerCount >= 7 ? 'flex' : 'none';
        doubleAgentCheckbox.disabled = playerCount < 7;
        impostorCheckbox.disabled = playerCount < 8;
    }
}
function getRoleName(role) { return {'Civilian':'–ñ–∏—Ç–µ–ª—å','Spy':'–®–ø–∏–æ–Ω','Detective':'–î–µ—Ç–µ–∫—Ç–∏–≤','DoubleAgent':'–î–≤–æ–π–Ω–æ–π –∞–≥–µ–Ω—Ç','Impostor':'–°–∞–º–æ–∑–≤–∞–Ω–µ—Ü'}[role]||'??'; }
function updateGameUI() {
    if (!gameState.gameStarted) return;
    document.getElementById('timer').textContent = new Date(gameState.timer * 1000).toISOString().substr(14, 5);
    const self = gameState.players.find(p => p.id === myId);
    if (!self) return;
    document.getElementById('my-role').innerHTML = `–†–æ–ª—å: <span class="role-${self.role.toLowerCase()}">${getRoleName(self.role)}</span>`;
    const playerList = document.getElementById('player-list'); playerList.innerHTML = '';
    gameState.players.forEach(p => {
        const card = document.createElement('div'); card.className = 'player-card';
        if (p.id === myId) card.classList.add('is-you'); if (!p.isAlive) card.classList.add('is-dead');
        if (self.role === 'Spy' && p.role === 'Spy') card.classList.add('is-spy');
        card.innerHTML = `<span>${p.name} (${p.votes || 0} –≥–æ–ª–æ—Å–æ–≤)</span><div class="player-actions"></div>`;
        if (self.isAlive && p.isAlive && p.id !== myId) {
            const actionsDiv = card.querySelector('.player-actions');
            if (self.role !== 'Detective' && self.role !== 'Impostor') {
                 actionsDiv.innerHTML += `<button onclick="sendAction({type:'vote',targetId:'${p.id}'})">–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å</button>`;
            }
            if (self.canCheck) actionsDiv.innerHTML += `<button onclick="sendAction({type:'check',targetId:'${p.id}'})">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>`;
            if (self.canCheckSpy) actionsDiv.innerHTML += `<button onclick="sendAction({type:'check_spy',targetId:'${p.id}'})">–ù–∞–π—Ç–∏ —à–ø–∏–æ–Ω–∞</button>`;
        }
        playerList.appendChild(card);
    });
    document.getElementById('sabotage-btn').style.display = (self.role === 'Spy' && self.isAlive && gameState.sabotageReady) ? 'block' : 'none';
}
function sendAction(payload) {
    if (isHost) handlePlayerAction(payload, myId);
    else Object.values(peers)[0].send(JSON.stringify({ type: 'player_action', payload }));
}
function gameTick() {
    if (gameState.timer > 0) gameState.timer--;
    else return endGame('Spy');
    broadcastGameState();
}
function handlePlayerAction(payload, playerId) {
    const player = gameState.players.find(p => p.id === playerId);
    if (!player || !player.isAlive) return;
    switch (payload.type) {
        case 'vote':
            if (player.role === 'Detective' || player.role === 'Impostor') return;
            const target = gameState.players.find(p => p.id === payload.targetId);
            if (target) {
                target.votes = (target.votes || 0) + 1;
                const aliveVoters = gameState.players.filter(p => p.isAlive && p.role !== 'Detective' && p.role !== 'Impostor').length;
                if (target.votes > aliveVoters / 2) { target.isAlive = false; gameState.players.forEach(p => p.votes = 0); checkWinConditions(); }
                else broadcastGameState();
            }
            break;
        case 'check': if (player.canCheck) { player.canCheck = false; broadcastGameState(); } break;
        case 'check_spy': if (player.canCheckSpy) { player.canCheckSpy = false; broadcastGameState(); } break;
        case 'sabotage': if ((player.role === 'Spy' || player.role === 'DoubleAgent') && gameState.sabotageReady) {
            gameState.sabotageReady = false; broadcastGameState();
            setTimeout(() => { gameState.sabotageReady = true; broadcastGameState(); }, 30000);
        } break;
    }
}
function assignRoles() {
    const players = gameState.players; let roles = Array(players.length).fill('Civilian');
    const playerCount = players.length;
    const useDoubleAgent = isHost && document.getElementById('enable-double-agent').checked && playerCount >= 7;
    const useImpostor = isHost && document.getElementById('enable-impostor').checked && playerCount >= 8;
    let numSpies = Math.max(1, Math.floor(playerCount / 4));
    let numDetectives = playerCount > 4 ? 1 : 0;
    
    let roleIndex = 0;
    for (let i = 0; i < numSpies; i++) roles[roleIndex++] = 'Spy';
    if (numDetectives > 0) roles[roleIndex++] = 'Detective';
    if (useDoubleAgent) {
        roles[roleIndex++] = 'DoubleAgent';
        if (numSpies > 1) roles[0] = 'Civilian';
    }
    if (useImpostor) roles[roleIndex++] = 'Impostor';
    
    for (let i = roles.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [roles[i], roles[j]] = [roles[j], roles[i]]; }
    players.forEach((player, i) => player.role = roles[i]);
}
function resetPlayerStats() {
    gameState.timer = 300; gameState.sabotageReady = true;
    gameState.players.forEach(p => { 
        p.isAlive = true; p.votes = 0; 
        p.canCheck = (p.role === 'Detective');
        p.canCheckSpy = (p.role === 'DoubleAgent');
    });
}
function checkWinConditions() {
    if (gameState.gameOver) return;
    const impostor = gameState.players.find(p => p.role === 'Impostor' && p.isAlive);
    const alivePlayers = gameState.players.filter(p => p.isAlive);
    if (impostor && alivePlayers.length <= 2) return endGame('Impostor');

    const aliveSpies = gameState.players.filter(p => p.isAlive && (p.role === 'Spy' || p.role === 'DoubleAgent'));
    const aliveCivilians = gameState.players.filter(p => p.isAlive && (p.role === 'Civilian' || p.role === 'Detective' || p.role === 'Bodyguard'));
    if (aliveSpies.length === 0) endGame('Civilian');
    else if (aliveSpies.length >= aliveCivilians.length) endGame('Spy');
}
function endGame(winner) {
    if (gameState.gameOver) return;
    const impostor = gameState.players.find(p => p.role === 'Impostor' && p.isAlive);
    if (impostor) winner = 'Impostor';

    gameState.gameOver = true; clearInterval(timerInterval);
    const results = { winner: winner, players: gameState.players.map(p => ({name:p.name, role:p.role})) };
    showResults(results);
    broadcastToPeers({ type: 'game_over', results: results });
}
function showResults(results) {
    showScreen('results-screen');
    document.getElementById('winner-display').textContent = `–ü–æ–±–µ–¥–∏–ª–∏: ${getRoleName(results.winner)}`;
    const list = document.getElementById('results-list'); list.innerHTML = '';
    results.players.forEach(p => { list.innerHTML += `<li>${p.name} ‚Äî <span class="role-${p.role.toLowerCase()}">${getRoleName(p.role)}</span></li>`; });
}
// –õ–æ–≥–∏–∫–∞ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
const accordions = document.querySelectorAll(".accordion");
accordions.forEach(acc => {
    acc.addEventListener("click", function() {
        this.classList.toggle("active");
        const panel = this.nextElementSibling;
        if (panel.style.maxHeight) { panel.style.maxHeight = null; }
        else { panel.style.maxHeight = panel.scrollHeight + "px"; }
    });
});
</script>
</body>
</html>
